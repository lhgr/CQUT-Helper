name: Flutter Build and Release APK

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæ¨é€tagæ—¶
  push:
    tags:
      - 'v*'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'Release notes'
        required: false
        default: 'ğŸ“± æ‰‹åŠ¨è§¦å‘çš„åº”ç”¨å‘å¸ƒ'
      create_tag:
        description: 'Create git tag automatically'
        type: boolean
        required: false
        default: true

# è®¾ç½®æƒé™
permissions:
  contents: write  # ç”¨äºåˆ›å»ºRelease
  actions: read
  checks: write

jobs:
  build-and-release:
    name: Build Flutter APK and Create Release
    runs-on: ubuntu-latest
    
    env:
      TZ: Asia/Shanghai
      FLUTTER_CHANNEL: 'stable'
      
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºåˆ›å»ºtag
          ref: ${{ github.event.inputs.tag_name && 'main' || github.ref }}
      
      # 2. è®¾ç½®æ—¶åŒºï¼ˆå½»åº•è§£å†³æ—¶åŒºé—®é¢˜ï¼‰
      - name: Configure timezone
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "å½“å‰ç³»ç»Ÿæ—¶é—´ï¼š"
          date
          echo "å½“å‰æ—¶åŒºï¼š"
          timedatectl
      
      # 3. è®¾ç½®Flutterç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ env.FLUTTER_CHANNEL }}-${{ hashFiles('**/pubspec.lock') }}
          
      # 4. éªŒè¯Flutterç¯å¢ƒ
      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v
      
      # 5. è·å–ä¾èµ–
      - name: Get dependencies
        run: flutter pub get
      
      # 6. è®¾ç½®Firebaseé…ç½®ï¼ˆä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼‰
      - name: Setup Firebase configuration
        env:
          FIREBASE_OPTIONS_BASE64: ${{ secrets.FIREBASE_OPTIONS_BASE64 }}
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          # éªŒè¯å¯†é’¥æ˜¯å¦å­˜åœ¨
          if [ -z "$FIREBASE_OPTIONS_BASE64" ]; then
            echo "âŒ FIREBASE_OPTIONS_BASE64 secret is missing"
            exit 1
          fi
          
          if [ -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
            echo "âŒ GOOGLE_SERVICES_JSON_BASE64 secret is missing"
            exit 1
          fi
          
          # è§£ç å¹¶ä¿å­˜Firebaseé…ç½®
          echo "$FIREBASE_OPTIONS_BASE64" | base64 -d > lib/firebase_options.dart
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 -d > android/app/google-services.json
          
          echo "âœ… Firebaseé…ç½®å·²è®¾ç½®"
      
      # 7. éªŒè¯é…ç½®æ–‡ä»¶
      - name: Verify configuration files
        run: |
          echo "ğŸ“ éªŒè¯é…ç½®æ–‡ä»¶ï¼š"
          ls -la android/app/google-services.json && echo "âœ… google-services.json å­˜åœ¨" || echo "âŒ google-services.json ä¸å­˜åœ¨"
          ls -la lib/firebase_options.dart && echo "âœ… firebase_options.dart å­˜åœ¨" || echo "âŒ firebase_options.dart ä¸å­˜åœ¨"
          
          # éªŒè¯æ–‡ä»¶å†…å®¹
          if [ -f "android/app/google-services.json" ]; then
            echo "google-services.json æ–‡ä»¶å¤§å°ï¼š" $(wc -l < android/app/google-services.json) "è¡Œ"
          fi
          
          if [ -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart æ–‡ä»¶å¤§å°ï¼š" $(wc -l < lib/firebase_options.dart) "è¡Œ"
          fi
      
      # 8. åˆ›å»ºç‰ˆæœ¬åç§°å’Œæ„å»ºæ—¶é—´
      - name: Generate build info
        run: |
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          BUILD_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_NAME=${{ github.event.inputs.tag_name }}
          else
            VERSION_NAME=${GITHUB_REF#refs/tags/}
          fi
          
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          
          echo "ğŸ“± æ„å»ºä¿¡æ¯ï¼š"
          echo "ç‰ˆæœ¬: $VERSION_NAME"
          echo "æ„å»ºæ—¶é—´: $BUILD_DATE"
          echo "æ„å»ºæ—¶é—´æˆ³: $BUILD_TIMESTAMP"
      
      # 9. åˆ†æé¡¹ç›®
      - name: Analyze Flutter project
        run: flutter analyze
      
      # 10. è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: flutter test
      
      # 11. æ„å»ºé€šç”¨APK
      - name: Build universal APK
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé€šç”¨APK..."
          flutter build apk --release
          
          # é‡å‘½åAPKæ–‡ä»¶ï¼ŒåŒ…å«ç‰ˆæœ¬ä¿¡æ¯
          cp build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/CQUT-Helper-${{ env.VERSION_NAME }}-universal-${{ env.BUILD_TIMESTAMP }}.apk
          
          echo "âœ… é€šç”¨APKæ„å»ºå®Œæˆ"
      
      # 12. æ„å»ºåˆ†æ¶æ„APKï¼ˆå‡å°‘æ–‡ä»¶å¤§å°ï¼‰
      - name: Build split APKs
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºåˆ†æ¶æ„APK..."
          flutter build apk --release --split-per-abi
          
          # é‡å‘½ååˆ†æ¶æ„APKæ–‡ä»¶
          for file in build/app/outputs/flutter-apk/app-*-release.apk; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              arc
